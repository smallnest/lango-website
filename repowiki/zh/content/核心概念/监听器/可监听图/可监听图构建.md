# å¯ç›‘å¬å›¾æ„å»º

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [listeners.go](file://graph/listeners.go)
- [graph.go](file://graph/graph.go)
- [listeners_test.go](file://graph/listeners_test.go)
- [checkpointing.go](file://graph/checkpointing.go)
- [streaming.go](file://graph/streaming.go)
- [main.go](file://examples/listeners/main.go)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [NewListenableMessageGraph å‡½æ•°è¯¦è§£](#newlistenablemessagegraph-å‡½æ•°è¯¦è§£)
4. [ç»“æ„ä½“ç»„åˆæ¨¡å¼åˆ†æ](#ç»“æ„ä½“ç»„åˆæ¨¡å¼åˆ†æ)
5. [åˆå§‹åŒ–é€»è¾‘æ·±åº¦è§£æ](#åˆå§‹åŒ–é€»è¾‘æ·±åº¦è§£æ)
6. [æ‰©å±•ä¼˜åŠ¿ä¸è®¾è®¡è€ƒé‡](#æ‰©å±•ä¼˜åŠ¿ä¸è®¾è®¡è€ƒé‡)
7. [å›¾æ„å»ºé˜¶æ®µçš„ååŒå·¥ä½œ](#å›¾æ„å»ºé˜¶æ®µçš„ååŒå·¥ä½œ)
8. [åˆå§‹çŠ¶æ€ç®¡ç†æœºåˆ¶](#åˆå§‹çŠ¶æ€ç®¡ç†æœºåˆ¶)
9. [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯)
10. [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)
11. [æ€»ç»“](#æ€»ç»“)

## ç®€ä»‹

NewListenableMessageGraph å‡½æ•°æ˜¯ langgraphgo æ¡†æ¶ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªå…·æœ‰ç›‘å¬å™¨æ”¯æŒçš„æ¶ˆæ¯å›¾å®ä¾‹ã€‚è¯¥å‡½æ•°é€šè¿‡ç»„åˆæ¨¡å¼å®ç°äº†åŸºç¡€æ¶ˆæ¯å›¾åŠŸèƒ½ä¸ç›‘å¬èƒ½åŠ›çš„æ— ç¼é›†æˆï¼Œåœ¨ä¿æŒå‘åå…¼å®¹æ€§çš„åŒæ—¶ä¸ºå¼€å‘è€…æä¾›äº†å¼ºå¤§çš„å¯è§‚æµ‹æ€§å’Œè°ƒè¯•èƒ½åŠ›ã€‚

## æ ¸å¿ƒæ¶æ„

```mermaid
classDiagram
class MessageGraph {
+nodes map[string]Node
+edges []Edge
+conditionalEdges map[string]func
+entryPoint string
+AddNode(name, fn)
+AddEdge(from, to)
+SetEntryPoint(name)
}
class ListenableNode {
+Node
+listeners []NodeListener
+mutex sync.RWMutex
+Execute(ctx, state)
+NotifyListeners(ctx, event, state, err)
+AddListener(listener)
+RemoveListener(listener)
}
class ListenableMessageGraph {
+*MessageGraph
+listenableNodes map[string]*ListenableNode
+AddNode(name, fn)
+GetListenableNode(name)
+AddGlobalListener(listener)
+RemoveGlobalListener(listener)
}
class ListenableRunnable {
+graph *ListenableMessageGraph
+listenableNodes map[string]*ListenableNode
+Invoke(ctx, initialState)
+InvokeWithConfig(ctx, initialState, config)
}
MessageGraph <|-- ListenableMessageGraph : ç»„åˆ
Node <|-- ListenableNode : ç»„åˆ
ListenableMessageGraph --> ListenableNode : ç®¡ç†
ListenableMessageGraph --> ListenableRunnable : ç¼–è¯‘
```

**å›¾è¡¨æ¥æº**
- [listeners.go](file://graph/listeners.go#L89-L191)
- [graph.go](file://graph/graph.go#L74-L92)

## NewListenableMessageGraph å‡½æ•°è¯¦è§£

NewListenableMessageGraph å‡½æ•°æ˜¯åˆ›å»ºå¯ç›‘å¬æ¶ˆæ¯å›¾çš„æ ¸å¿ƒå…¥å£ç‚¹ï¼Œå…¶å®ç°ä½“ç°äº†ä¼˜é›…çš„è®¾è®¡æ¨¡å¼å’Œæ¸…æ™°çš„èŒè´£åˆ†ç¦»ã€‚

### å‡½æ•°ç­¾åä¸è¿”å›å€¼

```go
func NewListenableMessageGraph() *ListenableMessageGraph
```

è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘ ListenableMessageGraph ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„ä½“åŒ…å«äº†ä¸¤ä¸ªå…³é”®ç»„ä»¶ï¼š
- åµŒå…¥çš„åŸºç¡€ MessageGraph å®ä¾‹
- ä¸“é—¨ç”¨äºç®¡ç†ç›‘å¬å™¨çš„ listenableNodes æ˜ å°„è¡¨

### åˆå§‹åŒ–è¿‡ç¨‹åˆ†æ

```mermaid
flowchart TD
Start([å‡½æ•°è°ƒç”¨å¼€å§‹]) --> CreateBase["åˆ›å»ºåŸºç¡€ MessageGraph<br/>NewMessageGraph()"]
CreateBase --> InitMap["åˆå§‹åŒ– listenableNodes æ˜ å°„è¡¨<br/>make(map[string]*ListenableNode)"]
InitMap --> Return["è¿”å› ListenableMessageGraph å®ä¾‹"]
Return --> End([åˆå§‹åŒ–å®Œæˆ])
```

**å›¾è¡¨æ¥æº**
- [listeners.go](file://graph/listeners.go#L193-L198)

**ç« èŠ‚æ¥æº**
- [listeners.go](file://graph/listeners.go#L193-L198)

## ç»“æ„ä½“ç»„åˆæ¨¡å¼åˆ†æ

ListenableMessageGraph é‡‡ç”¨äº†ç»å…¸çš„ç»„åˆæ¨¡å¼è®¾è®¡ï¼Œè¿™ç§è®¾è®¡å¸¦æ¥äº†æ˜¾è‘—çš„ä¼˜åŠ¿ï¼š

### ç»§æ‰¿å…³ç³»ä¸ç»„åˆä¼˜åŠ¿

```mermaid
graph TB
subgraph "åŸºç¡€åŠŸèƒ½å±‚"
MG[MessageGraph<br/>åŸºç¡€å›¾åŠŸèƒ½]
end
subgraph "æ‰©å±•åŠŸèƒ½å±‚"
LMN[ListenableNode<br/>èŠ‚ç‚¹ç›‘å¬èƒ½åŠ›]
LMG[ListenableMessageGraph<br/>å›¾ç›‘å¬èƒ½åŠ›]
end
subgraph "åº”ç”¨å±‚"
LR[ListenableRunnable<br/>å¯æ‰§è¡Œå®ä¾‹]
end
MG --> LMN
LMN --> LMG
LMG --> LR
style MG fill:#e1f5fe
style LMN fill:#f3e5f5
style LMG fill:#e8f5e8
style LR fill:#fff3e0
```

**å›¾è¡¨æ¥æº**
- [listeners.go](file://graph/listeners.go#L187-L191)

### è®¾è®¡æ¨¡å¼ä¼˜åŠ¿

1. **è¡Œä¸ºæ‰©å±•è€Œéä¿®æ”¹**: é€šè¿‡ç»„åˆè€Œéç»§æ‰¿çš„æ–¹å¼æ·»åŠ ç›‘å¬åŠŸèƒ½
2. **å•ä¸€èŒè´£åŸåˆ™**: åŸºç¡€å›¾åŠŸèƒ½ä¸ç›‘å¬åŠŸèƒ½åˆ†ç¦»
3. **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
4. **æ¥å£éš”ç¦»**: æ¸…æ™°çš„æ¥å£è¾¹ç•Œå®šä¹‰

**ç« èŠ‚æ¥æº**
- [listeners.go](file://graph/listeners.go#L187-L191)

## åˆå§‹åŒ–é€»è¾‘æ·±åº¦è§£æ

### åŸºç¡€å›¾åˆå§‹åŒ–

NewListenableMessageGraph å‡½æ•°é¦–å…ˆè°ƒç”¨ NewMessageGraph åˆ›å»ºåŸºç¡€å›¾å®ä¾‹ï¼š

```go
MessageGraph: NewMessageGraph()
```

è¿™è¡Œä»£ç åˆ›å»ºäº†ä¸€ä¸ªå…¨æ–°çš„ MessageGraph å®ä¾‹ï¼Œåˆå§‹åŒ–äº†ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š
- `nodes`: èŠ‚ç‚¹æ˜ å°„è¡¨ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰å›¾èŠ‚ç‚¹
- `conditionalEdges`: æ¡ä»¶è¾¹æ˜ å°„è¡¨ï¼Œå¤„ç†åŠ¨æ€è·¯ç”±é€»è¾‘
- é»˜è®¤é…ç½®å‚æ•°

### ç›‘å¬å™¨æ˜ å°„è¡¨åˆå§‹åŒ–

```go
listenableNodes: make(map[string]*ListenableNode)
```

è¿™è¡Œä»£ç åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„æ˜ å°„è¡¨ï¼Œç”¨äºç®¡ç†æ‰€æœ‰å…·æœ‰ç›‘å¬èƒ½åŠ›çš„èŠ‚ç‚¹ã€‚è¯¥æ˜ å°„è¡¨çš„å…³é”®ç‰¹æ€§åŒ…æ‹¬ï¼š

1. **é”®å€¼ç±»å‹**: å­—ç¬¦ä¸²ç±»å‹çš„èŠ‚ç‚¹åç§°ä½œä¸ºé”®
2. **å€¼ç±»å‹**: ListenableNode æŒ‡é’ˆä½œä¸ºå€¼
3. **å¹¶å‘å®‰å…¨**: åç»­é€šè¿‡äº’æ–¥é”ä¿è¯çº¿ç¨‹å®‰å…¨

### åˆå§‹åŒ–æ—¶åºå›¾

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯ä»£ç 
participant NLMG as NewListenableMessageGraph
participant MG as MessageGraph
participant LMN as ListenableNodeæ˜ å°„è¡¨
Client->>NLMG : è°ƒç”¨ NewListenableMessageGraph()
NLMG->>MG : NewMessageGraph()
MG-->>NLMG : è¿”å›åŸºç¡€å›¾å®ä¾‹
NLMG->>LMN : make(map[string]*ListenableNode)
LMN-->>NLMG : è¿”å›ç©ºæ˜ å°„è¡¨
NLMG-->>Client : è¿”å› ListenableMessageGraph å®ä¾‹
Note over Client,LMN : å›¾å®ä¾‹å·²åˆå§‹åŒ–å®Œæˆ
```

**å›¾è¡¨æ¥æº**
- [listeners.go](file://graph/listeners.go#L193-L198)

**ç« èŠ‚æ¥æº**
- [listeners.go](file://graph/listeners.go#L193-L198)

## æ‰©å±•ä¼˜åŠ¿ä¸è®¾è®¡è€ƒé‡

### åŠŸèƒ½æ‰©å±•ä¼˜åŠ¿

NewListenableMessageGraph çš„è®¾è®¡å¸¦æ¥äº†å¤šé‡åŠŸèƒ½æ‰©å±•ä¼˜åŠ¿ï¼š

#### 1. ç›‘å¬å™¨ç³»ç»Ÿé›†æˆ

```mermaid
graph LR
subgraph "äº‹ä»¶ç±»å‹"
SE[NodeEventStart]
PE[NodeEventProgress]
CE[NodeEventComplete]
EE[NodeEventError]
end
subgraph "ç›‘å¬å™¨å®ç°"
PL[ProgressListener]
ML[MetricsListener]
CL[ChatListener]
LL[LoggingListener]
end
subgraph "é€šçŸ¥æœºåˆ¶"
NL[NotifyListeners]
WG[WaitGroupåŒæ­¥]
GR[goroutineå¹¶è¡Œ]
end
SE --> NL
PE --> NL
CE --> NL
EE --> NL
NL --> WG
WG --> GR
PL --> NL
ML --> NL
CL --> NL
LL --> NL
```

**å›¾è¡¨æ¥æº**
- [listeners.go](file://graph/listeners.go#L128-L157)

#### 2. å…¨å±€ç›‘å¬å™¨æ”¯æŒ

```go
// æ·»åŠ å…¨å±€ç›‘å¬å™¨åˆ°æ‰€æœ‰èŠ‚ç‚¹
func (g *ListenableMessageGraph) AddGlobalListener(listener NodeListener) {
    for _, node := range g.listenableNodes {
        node.AddListener(listener)
    }
}
```

è¿™ç§è®¾è®¡å…è®¸å¼€å‘è€…ï¼š
- åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ ç›‘å¬å™¨
- ç»Ÿä¸€ç®¡ç†å¤šä¸ªèŠ‚ç‚¹çš„ç›‘å¬éœ€æ±‚
- å®ç°è·¨èŠ‚ç‚¹çš„ç»Ÿä¸€ç›‘æ§ç­–ç•¥

#### 3. å¼‚æ­¥äº‹ä»¶é€šçŸ¥

ç›‘å¬å™¨é€šçŸ¥é‡‡ç”¨å¼‚æ­¥æœºåˆ¶ï¼Œé¿å…é˜»å¡ä¸»æ‰§è¡Œæµç¨‹ï¼š

```go
// å¼‚æ­¥é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
for _, listener := range listeners {
    wg.Add(1)
    go func(l NodeListener) {
        defer wg.Done()
        // é˜²æ­¢ç›‘å¬å™¨å´©æºƒå½±å“ä¸»æµç¨‹
        defer func() {
            if r := recover(); r != nil {
                // æ¢å¤panicä½†ä¸è®°å½•é”™è¯¯
            }
        }()
        l.OnNodeEvent(ctx, event, ln.Name, state, err)
    }(listener)
}
```

**ç« èŠ‚æ¥æº**
- [listeners.go](file://graph/listeners.go#L222-L234)
- [listeners.go](file://graph/listeners.go#L128-L157)

## å›¾æ„å»ºé˜¶æ®µçš„ååŒå·¥ä½œ

### AddNode æ–¹æ³•çš„ååŒæœºåˆ¶

å½“åœ¨ ListenableMessageGraph ä¸­æ·»åŠ èŠ‚ç‚¹æ—¶ï¼Œç³»ç»Ÿä¼šåŒæ—¶ç»´æŠ¤ä¸¤ä¸ªå±‚æ¬¡çš„æ•°æ®ç»“æ„ï¼š

```mermaid
flowchart TD
AddNode[AddNodeè°ƒç”¨] --> CreateNode["åˆ›å»º Node ç»“æ„"]
CreateNode --> CreateListenable["åˆ›å»º ListenableNode"]
CreateListenable --> AddToBase["æ·»åŠ åˆ°åŸºç¡€ MessageGraph<br/>g.MessageGraph.AddNode()"]
AddToBase --> AddToListenable["æ·»åŠ åˆ° listenableNodes æ˜ å°„<br/>g.listenableNodes[name] = listenableNode"]
AddToListenable --> Return["è¿”å› ListenableNode"]
style AddToBase fill:#e3f2fd
style AddToListenable fill:#f3e5f5
```

**å›¾è¡¨æ¥æº**
- [listeners.go](file://graph/listeners.go#L202-L214)

### ç¼–è¯‘é˜¶æ®µçš„ååŒ

ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼ŒListenableMessageGraph ä¼šåˆ›å»º ListenableRunnable å®ä¾‹ï¼š

```go
func (g *ListenableMessageGraph) CompileListenable() (*ListenableRunnable, error) {
    if g.entryPoint == "" {
        return nil, ErrEntryPointNotSet
    }
    
    return &ListenableRunnable{
        graph:           g,
        listenableNodes: g.listenableNodes,
    }, nil
}
```

è¿™ç§è®¾è®¡ç¡®ä¿äº†ï¼š
1. **çŠ¶æ€ä¸€è‡´æ€§**: åŸºç¡€å›¾çŠ¶æ€ä¸ç›‘å¬å™¨çŠ¶æ€åŒæ­¥
2. **æ‰§è¡Œé€æ˜æ€§**: ç›‘å¬å™¨ä¸å½±å“æ ¸å¿ƒæ‰§è¡Œé€»è¾‘
3. **èµ„æºä¼˜åŒ–**: é¿å…é‡å¤åˆ›å»ºç›¸åŒçš„åŠŸèƒ½ç»„ä»¶

**ç« èŠ‚æ¥æº**
- [listeners.go](file://graph/listeners.go#L202-L214)
- [listeners.go](file://graph/listeners.go#L242-L252)

## åˆå§‹çŠ¶æ€ç®¡ç†æœºåˆ¶

### å›¾å®ä¾‹åŒ–åçš„åˆå§‹çŠ¶æ€

NewListenableMessageGraph åˆ›å»ºçš„å›¾å®ä¾‹å…·æœ‰ä»¥ä¸‹åˆå§‹çŠ¶æ€ç‰¹å¾ï¼š

#### 1. ç©ºèŠ‚ç‚¹é›†åˆ
- `nodes` æ˜ å°„è¡¨ä¸ºç©ºï¼Œç­‰å¾…èŠ‚ç‚¹æ·»åŠ 
- `conditionalEdges` æ˜ å°„è¡¨ä¸ºç©ºï¼Œæ— æ¡ä»¶è¾¹é…ç½®

#### 2. ç›‘å¬å™¨æ˜ å°„è¡¨çŠ¶æ€
- `listenableNodes` æ˜ å°„è¡¨ä¸ºç©ºï¼Œç­‰å¾… ListenableNode æ·»åŠ 
- æ‰€æœ‰ç›‘å¬å™¨æ“ä½œéƒ½åŸºäºæ­¤æ˜ å°„è¡¨è¿›è¡Œ

#### 3. æ‰§è¡Œç¯å¢ƒå‡†å¤‡
- `entryPoint` ä¸ºç©ºï¼Œéœ€è¦æ˜¾å¼è®¾ç½®å…¥å£èŠ‚ç‚¹
- `Schema` ä¸ºé›¶å€¼ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€å¤„ç†é€»è¾‘

### çŠ¶æ€è½¬æ¢æµç¨‹

```mermaid
stateDiagram-v2
[*] --> Initialized : NewListenableMessageGraph()
Initialized --> NodesAdded : AddNode()
Initialized --> EntryPointSet : SetEntryPoint()
NodesAdded --> EntryPointSet : SetEntryPoint()
EntryPointSet --> Ready : å›¾é…ç½®å®Œæˆ
Ready --> Executing : Invoke()
Executing --> Completed : æ‰§è¡Œå®Œæˆ
Completed --> [*]
note right of Initialized
- ç©ºçš„ nodes æ˜ å°„è¡¨
- ç©ºçš„ listenableNodes æ˜ å°„è¡¨
- entryPoint ä¸ºç©º
end note
note right of Ready
- æ‰€æœ‰å¿…éœ€é…ç½®å·²å®Œæˆ
- å¯ä»¥å¼€å§‹æ‰§è¡Œ
- ç›‘å¬å™¨å¯ä»¥éšæ—¶æ·»åŠ 
end note
```

**å›¾è¡¨æ¥æº**
- [listeners.go](file://graph/listeners.go#L193-L198)

### åˆå§‹çŠ¶æ€éªŒè¯

æ¡†æ¶æä¾›äº†å¤šç§æ–¹å¼éªŒè¯å›¾å®ä¾‹çš„åˆå§‹çŠ¶æ€ï¼š

```go
// ç¼–è¯‘å‰çš„çŠ¶æ€æ£€æŸ¥
func (g *ListenableMessageGraph) CompileListenable() (*ListenableRunnable, error) {
    if g.entryPoint == "" {
        return nil, ErrEntryPointNotSet
    }
    // ç»§ç»­ç¼–è¯‘æµç¨‹...
}
```

**ç« èŠ‚æ¥æº**
- [listeners.go](file://graph/listeners.go#L193-L198)
- [listeners.go](file://graph/listeners.go#L244-L246)

## å®é™…åº”ç”¨åœºæ™¯

### ç¤ºä¾‹ï¼šå¤šç›‘å¬å™¨ç›‘æ§ç³»ç»Ÿ

ä»¥ä¸‹æ˜¯ NewListenableMessageGraph åœ¨å®é™…é¡¹ç›®ä¸­çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š

#### 1. è¿›åº¦ç›‘æ§ç³»ç»Ÿ

```go
// åˆ›å»ºç›‘å¬å™¨å›¾
g := graph.NewListenableMessageGraph()

// æ·»åŠ è¿›åº¦ç›‘å¬å™¨
progressListener := graph.NewProgressListener().
    WithTiming(true).
    WithDetails(true)

// æ·»åŠ æŒ‡æ ‡ç›‘å¬å™¨
metricsListener := graph.NewMetricsListener()

// æ·»åŠ èŠå¤©ç›‘å¬å™¨
chatListener := graph.NewChatListener()
chatListener.SetNodeMessage("process", "ğŸ¤– æ­£åœ¨å¤„ç†æ•°æ®...")
chatListener.SetNodeMessage("analyze", "ğŸ” æ­£åœ¨åˆ†æç»“æœ...")

// æ·»åŠ èŠ‚ç‚¹å¹¶ç»‘å®šç›‘å¬å™¨
processNode := g.AddNode("process", processFunction)
processNode.AddListener(progressListener)
processNode.AddListener(metricsListener)
processNode.AddListener(chatListener)
```

#### 2. åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§

```go
// åˆ›å»ºå¸¦æœ‰å…¨å±€ç›‘å¬å™¨çš„å›¾
g := graph.NewListenableMessageGraph()

// æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ªç›‘å¬å™¨
tracerListener := NewDistributedTracerListener()

// æ·»åŠ å…¨å±€ç›‘å¬å™¨
g.AddGlobalListener(tracerListener)

// æ‰€æœ‰èŠ‚ç‚¹è‡ªåŠ¨è·å¾—è¿½è¸ªèƒ½åŠ›
```

#### 3. æµ‹è¯•ç¯å¢ƒç›‘æ§

```go
// åˆ›å»ºæµ‹è¯•ä¸“ç”¨å›¾
g := graph.NewListenableMessageGraph()

// æ·»åŠ æ—¥å¿—ç›‘å¬å™¨
loggingListener := graph.NewLoggingListener().
    WithLogLevel(graph.LogLevelDebug).
    WithState(true)

// æ·»åŠ æ€§èƒ½ç›‘æ§ç›‘å¬å™¨
perfListener := NewPerformanceMonitor()

// åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¯ç”¨æ‰€æœ‰ç›‘æ§
testNode := g.AddNode("test", testFunction)
testNode.AddListener(loggingListener)
testNode.AddListener(perfListener)
```

**ç« èŠ‚æ¥æº**
- [main.go](file://examples/listeners/main.go#L12-L130)

## æ€§èƒ½è€ƒè™‘

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–

NewListenableMessageGraph çš„å†…å­˜ä½¿ç”¨ç‰¹ç‚¹ï¼š

#### 1. å°å¯¹è±¡å¼€é”€
- ListenableMessageGraph ç»“æ„ä½“å¤§å°ï¼šçº¦ 24 å­—èŠ‚ï¼ˆ64ä½ç³»ç»Ÿï¼‰
- æ¯ä¸ª ListenableNode ç»“æ„ä½“å¤§å°ï¼šçº¦ 48 å­—èŠ‚ï¼ˆåŒ…å« Nodeã€listeners å’Œ mutexï¼‰

#### 2. æ˜ å°„è¡¨å†…å­˜ä½¿ç”¨
- `listenableNodes` æ˜ å°„è¡¨æŒ‰éœ€å¢é•¿
- åˆå§‹å®¹é‡ä¸º 0ï¼Œéšç€èŠ‚ç‚¹æ·»åŠ åŠ¨æ€æ‰©å±•

#### 3. ç›‘å¬å™¨å†…å­˜ç®¡ç†
- ç›‘å¬å™¨åˆ—è¡¨é‡‡ç”¨åˆ‡ç‰‡å­˜å‚¨ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹
- ä½¿ç”¨ WaitGroup ç¡®ä¿ç›‘å¬å™¨é€šçŸ¥å®Œæˆåæ‰ç»§ç»­

### å¹¶å‘æ€§èƒ½

```mermaid
graph TD
subgraph "å¹¶å‘æ§åˆ¶"
RM[è¯»å†™äº’æ–¥é”]
WM[WaitGroupåŒæ­¥]
PC[Panicæ¢å¤]
end
subgraph "æ€§èƒ½ä¼˜åŒ–"
GA[goroutineæ± åŒ–]
NC[éé˜»å¡é€šçŸ¥]
PR[Panicé˜²æŠ¤]
end
RM --> GA
WM --> NC
PC --> PR
style RM fill:#e8f5e8
style WM fill:#e3f2fd
style PC fill:#fff3e0
```

**å›¾è¡¨æ¥æº**
- [listeners.go](file://graph/listeners.go#L128-L157)

### æ€§èƒ½åŸºå‡†æµ‹è¯•

æ¡†æ¶æä¾›äº†è¯¦ç»†çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼š

```go
func BenchmarkListenableNode_Execute(b *testing.B) {
    // åŸºå‡†æµ‹è¯•é…ç½®
    node := graph.NewListenableNode(baseNode)
    node.AddListener(mockListener)
    
    // æ‰§è¡ŒåŸºå‡†æµ‹è¯•
    for i := 0; i < b.N; i++ {
        node.Execute(ctx, testState)
    }
}
```

**ç« èŠ‚æ¥æº**
- [listeners_test.go](file://graph/listeners_test.go#L461-L484)

## æ€»ç»“

NewListenableMessageGraph å‡½æ•°é€šè¿‡å·§å¦™çš„ç»„åˆæ¨¡å¼è®¾è®¡ï¼ŒæˆåŠŸåœ°å°†ç›‘å¬èƒ½åŠ›é›†æˆåˆ°åŸºç¡€æ¶ˆæ¯å›¾åŠŸèƒ½ä¸­ã€‚å…¶æ ¸å¿ƒä¼˜åŠ¿åŒ…æ‹¬ï¼š

### æŠ€æœ¯ä¼˜åŠ¿
1. **ä¼˜é›…çš„ç»„åˆæ¨¡å¼**: é€šè¿‡åµŒå…¥åŸºç¡€ MessageGraph å®ç°åŠŸèƒ½æ‰©å±•
2. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**: ç›‘å¬åŠŸèƒ½ä¸æ ¸å¿ƒå›¾åŠŸèƒ½å®Œå…¨è§£è€¦
3. **é«˜æ€§èƒ½å¼‚æ­¥é€šçŸ¥**: ä½¿ç”¨ goroutine å’Œ WaitGroup å®ç°éé˜»å¡äº‹ä»¶ä¼ æ’­
4. **çº¿ç¨‹å®‰å…¨è®¾è®¡**: é€šè¿‡äº’æ–¥é”ä¿æŠ¤å…±äº«çŠ¶æ€è®¿é—®

### åº”ç”¨ä»·å€¼
1. **å¯è§‚æµ‹æ€§å¢å¼º**: ä¸ºå¤æ‚å›¾æ‰§è¡Œæä¾›å…¨é¢çš„ç›‘æ§èƒ½åŠ›
2. **å¼€å‘ä½“éªŒæå‡**: æ”¯æŒå®æ—¶è¿›åº¦è·Ÿè¸ªã€æ€§èƒ½ç›‘æ§å’Œé”™è¯¯è¯Šæ–­
3. **æµ‹è¯•å‹å¥½**: æ–¹ä¾¿å®ç°å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. **ç”Ÿäº§å°±ç»ª**: æä¾›ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„ç›‘æ§å’Œè°ƒè¯•èƒ½åŠ›

### è®¾è®¡å“²å­¦
è¯¥å‡½æ•°ä½“ç°äº†ç°ä»£è½¯ä»¶è®¾è®¡çš„æœ€ä½³å®è·µï¼š
- **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
- **å•ä¸€èŒè´£**: æ¯ä¸ªç»„ä»¶éƒ½æœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œ
- **ç»„åˆä¼˜äºç»§æ‰¿**: é€šè¿‡ç»„åˆå®ç°åŠŸèƒ½æ‰©å±•
- **é˜²å¾¡æ€§ç¼–ç¨‹**: é€šè¿‡ panic æ¢å¤é˜²æ­¢ç›‘å¬å™¨å´©æºƒå½±å“ä¸»æµç¨‹

NewListenableMessageGraph ä¸ä»…æ˜¯ä¸€ä¸ªç®€å•çš„å·¥å‚å‡½æ•°ï¼Œæ›´æ˜¯æ•´ä¸ª langgraphgo æ¡†æ¶å¯è§‚æµ‹æ€§ä½“ç³»çš„åŸºçŸ³ï¼Œä¸ºæ„å»ºå¯é ã€å¯ç›‘æ§çš„å›¾åº”ç”¨ç¨‹åºæä¾›äº†åšå®çš„åŸºç¡€ã€‚